"use strict";var __spreadArrays=this&&this.__spreadArrays||function(){for(var t=0,e=0,r=arguments.length;e<r;e++)t+=arguments[e].length;var n=Array(t),o=0;for(e=0;e<r;e++)for(var s=arguments[e],i=0,u=s.length;i<u;i++,o++)n[o]=s[i];return n};exports.__esModule=!0;var http_1=require("http"),querystring_1=require("querystring"),Simple=function(){function t(t){this.log=t,this.routes={GET:{},POST:{},PUT:{},DELETE:{}}}return t.prototype.listen=function(t,e,r){this.createNewServer().listen(t,e,null,r)},t.prototype.request=function(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];return this.addRequest(t,__spreadArrays(e)),this},t.prototype.get=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return this.addRequest("GET",t),this},t.prototype.post=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return this.addRequest("POST",t),this},t.prototype.put=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return this.addRequest("PUT",t),this},t.prototype.delete=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return this.addRequest("DELETE",t),this},t.prototype.parseQueryString=function(t){for(var e={},r=0,n=t.split("?");r<n.length;r++){var o=n[r].split("=");o&&2==o.length&&(e[o[0]]=o[1])}return e},t.prototype.parseBodyJSON=function(t){return new Promise((function(e,r){var n="";t.on("data",(function(t){(n+=t).length>1e6&&r("Too much data in request body")})),t.on("end",(function(){try{var t=JSON.parse(Object.keys(querystring_1.parse(n))[0]);e(t)}catch(t){r(t)}}))}))},t.prototype.handleRequest=function(t,e){var r=t.method,n=t.url;this.log&&console.log(r+" "+n);var o=n.split("?")[0];this.extendRequest(t),this.extendResponse(e);var s=this.routes[r];s&&s[o]?this.runHandlers(t,e,__spreadArrays(s[o])):e.writeHead(404,{"Content-Type":"application/json"}).end(JSON.stringify({success:!1,result:"No "+r+" route found matching "+o}))},t.prototype.runHandlers=function(t,e,r){var n=this;if(r&&r.length>0){var o=r.shift();0==r.length?o(t,e):o(t,e,(function(){return n.runHandlers(t,e,r)}))}},t.prototype.createNewServer=function(){var t=this;return http_1.createServer((function(e,r){t.handleRequest(e,r)}))},t.prototype.addRequest=function(t,e){var r=null,n=[];if(2==e.length&&"string"==typeof e[0]&&"function"==typeof e[1])r=e[0],n.push(e[1]);else{if(!(e.length>2&&"string"==typeof e[0]))throw new Error("Invalid arguments");r=e[0];for(var o=1;o<e.length;o++){if("function"!=typeof e[o])throw new Error("Argument after path is not a function");n.push(e[o])}}if(!(r&&n.length>0))throw new Error("Must specify a path and at least one route handler");this.routes[t][r]=n},t.prototype.extendResponse=function(t){return t.json=function(e,r){void 0===r&&(r=200),t.writeHead(r,{"Content-Type":"application/json"}).end(JSON.stringify(e))},t},t.prototype.extendRequest=function(t){var e=this;t.query=function(){return e.parseQueryString(t.url)},t.body=function(){return e.parseBodyJSON(t)}},t}();module.exports=Simple;
